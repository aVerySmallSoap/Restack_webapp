import SeverityBadge from '@/components/custom/SeverityBadge.vue';
import type { BasicVulnerability, FullVulnerability } from '@/lib/restack/historyParsers';
import type { ColumnDef } from '@tanstack/vue-table';
import { h } from 'vue';

// Create a union type for the table row data
export type Vulnerability = BasicVulnerability | FullVulnerability;

// Helper functions to get the correct data from either scan type
const getSeverity = (row: Vulnerability) => {
    return (row as any).severity || 'Informational';
};

const getCategory = (row: Vulnerability) => {
    return (row as BasicVulnerability).category || (row as FullVulnerability).type;
};

const getEndpoint = (row: Vulnerability) => {
    return (row as BasicVulnerability).path || (row as FullVulnerability).endpoint;
};

const getInfo = (row: Vulnerability) => {
    const info = (row as BasicVulnerability).info || (row as FullVulnerability).exploit;
    // Truncate long exploit strings for display in the table
    if (info && info.length > 100) {
        return `${info.substring(0, 100)}...`;
    }
    return info;
};

// Define the columns for the table
export const columns: ColumnDef<Vulnerability>[] = [
    {
        accessorKey: 'severity',
        header: 'Severity',
        // Render the SeverityBadge component in the cell
        cell: ({ row }) => {
            const severity = getSeverity(row.original);
            return h(SeverityBadge, { severity });
        },
        // Custom sorting logic for severity levels
        sortingFn: (rowA, rowB) => {
            const severityOrder = {
                Critical: 5,
                High: 4,
                Medium: 3,
                Low: 2,
                Informational: 1,
            };
            const sevA = severityOrder[getSeverity(rowA.original) as keyof typeof severityOrder] || 0;
            const sevB = severityOrder[getSeverity(rowB.original) as keyof typeof severityOrder] || 0;
            return sevA - sevB;
        },
        enableSorting: true,
    },
    {
        accessorKey: 'category',
        header: 'Category',
        cell: ({ row }) => h('span', { class: 'font-medium' }, getCategory(row.original)),
        enableSorting: true,
    },
    {
        accessorKey: 'endpoint',
        header: 'Endpoint / Path',
        cell: ({ row }) => h('span', { class: 'truncate font-mono text-xs' }, getEndpoint(row.original)),
        enableSorting: true,
    },
    {
        accessorKey: 'info',
        header: 'Details',
        cell: ({ row }) => h('span', { class: 'text-muted-foreground truncate' }, getInfo(row.original)),
        enableSorting: false, // Don't allow sorting by the snippet
    },
];
