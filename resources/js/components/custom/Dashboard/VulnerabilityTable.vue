<script setup lang="ts">
import { h, ref } from 'vue'
import {
    useVueTable,
    getCoreRowModel,
    getFilteredRowModel,
    getPaginationRowModel,
    getSortedRowModel,
    FlexRender,
    type ColumnDef,
    type SortingState,
} from '@tanstack/vue-table'
import type { PropType } from 'vue'
import DataTableColumnHeader from '@/components/custom/DataTableColumnHeader.vue'
import DataTablePagination from '@/components/custom/DataTablePagination.vue'
import { Card, CardContent, CardFooter, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { Table, TableHeader, TableRow, TableHead, TableBody, TableCell } from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { RawVulnerability } from '@/lib/restack/restack.types'

const props = defineProps({
    data: {
        type: Array as PropType<RawVulnerability[]>,
        required: true,
        default: () => [],
    },
})

// --- Helper Functions (Matching ScanResults.vue) ---

function getSeverityBadge(severity: string) {
    switch (severity?.toLowerCase()) {
        case 'critical':
        case 'high':
            return 'destructive'
        case 'medium':
            return 'default' // Usually dark/primary in shadcn
        case 'low':
            return 'secondary'
        default:
            return 'outline'
    }
}

function mapSeverityToNumber(sev: string) {
    switch (sev?.toLowerCase()) {
        case 'critical': return 4;
        case 'high': return 3;
        case 'medium': return 2;
        case 'low': return 1;
        default: return 0;
    }
}

// --- Table State ---
const sorting = ref<SortingState>([{ id: 'date', desc: true }])
const globalFilter = ref('')

// --- Columns Definition ---
const columns: ColumnDef<RawVulnerability>[] = [
    {
        accessorKey: 'severity',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Severity' }),
        cell: ({ row }) => {
            const severity = row.getValue('severity') as string
            return h(Badge, {
                variant: getSeverityBadge(severity),
                class: 'uppercase text-[10px] px-2 py-0.5'
            }, () => severity)
        },
        sortingFn: (a, b) => mapSeverityToNumber(b.original.severity) - mapSeverityToNumber(a.original.severity),
    },
    {
        accessorKey: 'type',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Vulnerability' }),
        cell: ({ row }) => h('div', { class: 'font-medium max-w-[250px] truncate' }, row.getValue('type')),
    },
    {
        accessorKey: 'endpoint',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Path' }),
        cell: ({ row }) => h('div', {
            class: 'truncate max-w-[200px] font-mono text-xs text-muted-foreground',
            title: row.getValue('endpoint')
        }, row.getValue('endpoint')),
    },
    {
        accessorKey: 'scanner',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Scanner' }),
        cell: ({ row }) => h('div', { class: 'text-xs' }, row.getValue('scanner')),
    },
    {
        accessorKey: 'target',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Target' }),
        cell: ({ row }) => h('div', { class: 'text-xs truncate max-w-[150px]' }, row.getValue('target')),
    },
    {
        accessorKey: 'date',
        header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Date' }),
        cell: ({ row }) => h('div', { class: 'text-xs text-muted-foreground' }, row.getValue('date')),
    },
]

// --- Table Initialization ---
const table = useVueTable({
    get data() { return props.data },
    columns,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    state: {
        get sorting() { return sorting.value },
        get globalFilter() { return globalFilter.value },
    },
    onSortingChange: (updater) => {
        sorting.value = typeof updater === 'function' ? updater(sorting.value) : updater
    },
    onGlobalFilterChange: (updater) => {
        globalFilter.value = typeof updater === 'function' ? updater(globalFilter.value) : updater
    },
})
</script>

<template>
    <Card class="mt-6">
        <CardHeader>
            <CardTitle>Detailed Findings</CardTitle>
            <CardDescription>
                Raw list of vulnerabilities matching your current filters.
            </CardDescription>
        </CardHeader>
        <CardContent>
            <div class="flex items-center py-4">
                <Input
                    placeholder="Search findings..."
                    :model-value="globalFilter"
                    @update:modelValue="globalFilter = String($event)"
                    class="max-w-sm h-8"
                />
            </div>
            <div class="rounded-md border">
                <Table>
                    <TableHeader>
                        <TableRow v-for="headerGroup in table.getHeaderGroups()" :key="headerGroup.id">
                            <TableHead v-for="header in headerGroup.headers" :key="header.id">
                                <FlexRender v-if="!header.isPlaceholder" :render="header.column.columnDef.header" :props="header.getContext()" />
                            </TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        <template v-if="table.getRowModel().rows.length">
                            <TableRow v-for="row in table.getRowModel().rows" :key="row.id">
                                <TableCell v-for="cell in row.getVisibleCells()" :key="cell.id">
                                    <FlexRender :render="cell.column.columnDef.cell" :props="cell.getContext()" />
                                </TableCell>
                            </TableRow>
                        </template>
                        <template v-else>
                            <TableRow>
                                <TableCell :colSpan="columns.length" class="h-24 text-center">
                                    No results found.
                                </TableCell>
                            </TableRow>
                        </template>
                    </TableBody>
                </Table>
            </div>
        </CardContent>
        <CardFooter>
            <DataTablePagination :table="table" />
        </CardFooter>
    </Card>
</template>
