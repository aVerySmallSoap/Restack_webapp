<script setup lang="ts">
import { computed } from 'vue'
import { VisArea, VisAxis, VisLine, VisXYContainer } from "@unovis/vue"
import { CurveType } from "@unovis/ts"
import { TrendingUp } from "lucide-vue-next"
import {
    Card,
    CardContent,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
} from "@/components/ui/card"
import {
    ChartContainer,
    ChartCrosshair,
    ChartTooltip,
    ChartTooltipContent,
    componentToString,
} from "@/components/ui/chart"
import { SEVERITY_CHART_CONFIG } from '@/lib/colors'

const props = defineProps<{
    data: Array<{ date: string, total: number, critical: number, high?: number, medium?: number, low?: number }>
}>()

// Use centralized color configuration
const chartConfig = SEVERITY_CHART_CONFIG

// Check if we have detailed severity breakdown or just total
const hasDetailedData = computed(() => {
    return props.data.some(d =>
        d.critical !== undefined || d.high !== undefined || d.medium !== undefined || d.low !== undefined
    )
})

// For stacked area chart (detailed severity data)
const categories = ['low', 'medium', 'high', 'critical'] as const
const xAccessor = (d: any) => new Date(d.date)
const yAccessors = categories.map(cat => (d: any) => d[cat] || 0)

// For single line chart (total only)
const yAccessorTotal = (d: any) => d.total

const totalVulns = computed(() => {
    if (hasDetailedData.value) {
        return props.data.reduce((sum, item) =>
            sum + (item.critical || 0) + (item.high || 0) + (item.medium || 0) + (item.low || 0), 0
        )
    }
    return props.data.reduce((sum, item) => sum + item.total, 0)
})

// Updated gradients using standardized colors
const svgDefs = `
  <linearGradient id="fillCritical" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="${chartConfig.critical.color}" stop-opacity="0.8" />
    <stop offset="95%" stop-color="${chartConfig.critical.color}" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillHigh" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="${chartConfig.high.color}" stop-opacity="0.8" />
    <stop offset="95%" stop-color="${chartConfig.high.color}" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillMedium" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="${chartConfig.medium.color}" stop-opacity="0.8" />
    <stop offset="95%" stop-color="${chartConfig.medium.color}" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillLow" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="${chartConfig.low.color}" stop-opacity="0.8" />
    <stop offset="95%" stop-color="${chartConfig.low.color}" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillTotal" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="${chartConfig.total.color}" stop-opacity="0.8" />
    <stop offset="95%" stop-color="${chartConfig.total.color}" stop-opacity="0.1" />
  </linearGradient>
`

// Helper to safely format dates
function formatDate(d: number | Date | string) {
    const date = new Date(d)
    if (isNaN(date.getTime())) return ''
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}
</script>

<template>
    <Card class="flex flex-col h-full shadow-sm">
        <CardHeader>
            <CardTitle>Vulnerability Trends</CardTitle>
            <CardDescription>
                Tracking findings severity over the selected period
            </CardDescription>
        </CardHeader>

        <CardContent class="flex-1 min-h-[300px]">
            <!-- Detailed Severity Breakdown (Stacked Area) -->
            <ChartContainer v-if="hasDetailedData" :config="chartConfig" class="h-full w-full">
                <VisXYContainer
                    :data="data"
                    :svg-defs="svgDefs"
                    :margin="{ top: 10, right: 10, bottom: 40, left: 50 }"
                >
                    <VisArea
                        :x="xAccessor"
                        :y="yAccessors"
                        :curve-type="CurveType.MonotoneX"
                        :color="['url(#fillLow)', 'url(#fillMedium)', 'url(#fillHigh)', 'url(#fillCritical)']"
                        :opacity="0.5"
                    />

                    <VisLine
                        :x="xAccessor"
                        :y="yAccessors"
                        :curve-type="CurveType.MonotoneX"
                        :color="[chartConfig.low.color, chartConfig.medium.color, chartConfig.high.color, chartConfig.critical.color]"
                        :line-width="1.5"
                    />

                    <VisAxis
                        type="x"
                        :x="xAccessor"
                        :tick-format="formatDate"
                        :grid-line="false"
                        :tick-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <VisAxis
                        type="y"
                        :y="yAccessors"
                        :tick-line="false"
                        :grid-line="true"
                        :domain-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <ChartTooltip />
                    <ChartCrosshair
                        :template="componentToString(chartConfig, ChartTooltipContent, {
                            labelFormatter: (d) => formatDate(d)
                        })"
                    />
                </VisXYContainer>
            </ChartContainer>

            <!-- Total Only (Simple Line) -->
            <ChartContainer v-else :config="{ total: chartConfig.total }" class="h-full w-full">
                <VisXYContainer
                    :data="data"
                    :svg-defs="svgDefs"
                    :margin="{ top: 10, right: 10, bottom: 40, left: 50 }"
                >
                    <VisArea
                        :x="xAccessor"
                        :y="[yAccessorTotal]"
                        :curve-type="CurveType.MonotoneX"
                        :color="['url(#fillTotal)']"
                        :opacity="0.5"
                    />

                    <VisLine
                        :x="xAccessor"
                        :y="[yAccessorTotal]"
                        :curve-type="CurveType.MonotoneX"
                        :color="[chartConfig.total.color]"
                        :line-width="2"
                    />

                    <VisAxis
                        type="x"
                        :x="xAccessor"
                        :tick-format="formatDate"
                        :grid-line="false"
                        :tick-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <VisAxis
                        type="y"
                        :y="[yAccessorTotal]"
                        :tick-line="false"
                        :grid-line="true"
                        :domain-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <ChartTooltip />
                    <ChartCrosshair
                        :template="componentToString({ total: chartConfig.total }, ChartTooltipContent, {
                            labelFormatter: (d) => formatDate(d)
                        })"
                    />
                </VisXYContainer>
            </ChartContainer>

            <!-- Legend -->
            <div class="mt-4 flex flex-wrap items-center justify-center gap-4">
                <div
                    v-if="hasDetailedData"
                    v-for="category in ['critical', 'high', 'medium', 'low']"
                    :key="category"
                    class="flex items-center gap-2"
                >
                    <div
                        class="h-3 w-3 rounded-sm"
                        :style="{ backgroundColor: chartConfig[category].color }"
                    />
                    <span class="text-sm font-medium capitalize text-muted-foreground">
                        {{ chartConfig[category].label }}
                    </span>
                </div>
                <div v-else class="flex items-center gap-2">
                    <div
                        class="h-3 w-3 rounded-sm"
                        :style="{ backgroundColor: chartConfig.total.color }"
                    />
                    <span class="text-sm font-medium text-muted-foreground">
                        {{ chartConfig.total.label }}
                    </span>
                </div>
            </div>
        </CardContent>

        <CardFooter>
            <div class="flex w-full items-start gap-2 text-sm">
                <div class="grid gap-2">
                    <div class="flex items-center gap-2 leading-none font-medium">
                        Total of {{ totalVulns }} findings in this period
                        <TrendingUp class="h-4 w-4 text-green-500" />
                    </div>
                </div>
            </div>
        </CardFooter>
    </Card>
</template>
