<script setup lang="ts">
import { computed } from 'vue'
import { VisArea, VisAxis, VisLine, VisXYContainer } from "@unovis/vue"
import { CurveType } from "@unovis/ts"
import { TrendingUp } from "lucide-vue-next"
import {
    Card,
    CardContent,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
} from "@/components/ui/card"
import {
    ChartContainer,
    ChartCrosshair,
    ChartTooltip,
    ChartTooltipContent,
    componentToString,
} from "@/components/ui/chart"

const props = defineProps<{
    data: Array<{ date: string, critical: number, high: number, medium: number, low: number }>
}>()

const chartConfig = {
    critical: { label: "Critical", color: "#ef4444" },
    high:     { label: "High",     color: "#f97316" },
    medium:   { label: "Medium",   color: "#eab308" },
    low:      { label: "Low",      color: "#3b82f6" },
}

const categories = ['low', 'medium', 'high', 'critical'] as const
const xAccessor = (d: any) => new Date(d.date)
const yAccessors = categories.map(cat => (d: any) => d[cat])

const totalVulns = computed(() =>
    props.data.reduce((sum, item) => sum + item.critical + item.high + item.medium + item.low, 0)
)

const svgDefs = `
  <linearGradient id="fillCritical" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="#ef4444" stop-opacity="0.8" />
    <stop offset="95%" stop-color="#ef4444" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillHigh" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="#f97316" stop-opacity="0.8" />
    <stop offset="95%" stop-color="#f97316" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillMedium" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="#eab308" stop-opacity="0.8" />
    <stop offset="95%" stop-color="#eab308" stop-opacity="0.1" />
  </linearGradient>
  <linearGradient id="fillLow" x1="0" y1="0" x2="0" y2="1">
    <stop offset="5%" stop-color="#3b82f6" stop-opacity="0.8" />
    <stop offset="95%" stop-color="#3b82f6" stop-opacity="0.1" />
  </linearGradient>
`

// Helper to safely format dates from both strings (data) and numbers (axis ticks)
function formatDate(d: number | Date | string) {
    const date = new Date(d)
    if (isNaN(date.getTime())) return ''
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}
</script>

<template>
    <Card class="flex flex-col h-full shadow-sm">
        <CardHeader>
            <CardTitle>Vulnerability Trends</CardTitle>
            <CardDescription>
                Tracking findings severity over the selected period
            </CardDescription>
        </CardHeader>

        <CardContent class="flex-1 min-h-[300px]">
            <ChartContainer :config="chartConfig" class="h-full w-full">
                <VisXYContainer
                    :data="data"
                    :svg-defs="svgDefs"
                    :margin="{ top: 10, right: 10, bottom: 40, left: 10 }"
                >
                    <VisArea
                        :x="xAccessor"
                        :y="yAccessors"
                        :curve-type="CurveType.MonotoneX"
                        :color="['url(#fillLow)', 'url(#fillMedium)', 'url(#fillHigh)', 'url(#fillCritical)']"
                        :opacity="0.5"
                    />

                    <VisLine
                        :x="xAccessor"
                        :y="yAccessors"
                        :curve-type="CurveType.MonotoneX"
                        :color="[chartConfig.low.color, chartConfig.medium.color, chartConfig.high.color, chartConfig.critical.color]"
                        :line-width="1.5"
                    />

                    <VisAxis
                        type="x"
                        :x="xAccessor"
                        :tick-format="formatDate"
                        :grid-line="false"
                        :tick-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <VisAxis
                        type="y"
                        :y="yAccessors"
                        :tick-line="false"
                        :grid-line="true"
                        :domain-line="false"
                        tick-text-color="hsl(var(--vis-text-color))"
                    />

                    <ChartTooltip />
                    <ChartCrosshair
                        :template="componentToString(chartConfig, ChartTooltipContent, {
                        labelFormatter: (d) => formatDate(d)
            })"
                    />
                </VisXYContainer>
            </ChartContainer>
        </CardContent>

        <CardFooter>
            <div class="flex w-full items-start gap-2 text-sm">
                <div class="grid gap-2">
                    <div class="flex items-center gap-2 leading-none font-medium">
                        Total of {{ totalVulns }} findings in this period <TrendingUp class="h-4 w-4 text-green-500" />
                    </div>
                </div>
            </div>
        </CardFooter>
    </Card>
</template>

<style>
</style>
