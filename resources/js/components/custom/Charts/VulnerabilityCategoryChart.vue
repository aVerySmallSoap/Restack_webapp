<script setup lang="ts">
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { BarChart, type BarChartData } from '@/components/ui/chart-bar';
import type { FullVulnerability } from '@/lib/restack/historyParsers';
import { computed } from 'vue';

// Define props to accept vulnerability data
const props = defineProps<{
    vulnerabilities: FullVulnerability[];
}>();

// Process data for the bar chart
const categoryCounts = computed(() => {
    const counts = new Map<string, number>();
    for (const vuln of props.vulnerabilities) {
        const category = vuln.type;
        counts.set(category, (counts.get(category) || 0) + 1);
    }

    // Sort by count descending and take top 10
    return Array.from(counts.entries())
        .sort(([, countA], [, countB]) => countB - countA)
        .slice(0, 10);
});

// Format data for the chart component
const chartData = computed<BarChartData[]>(() => {
    return categoryCounts.value.map(([name, total]) => ({
        name: name,
        total: total,
    }));
});
</script>

<template>
    <Card class="flex h-full flex-col">
        <CardHeader>
            <CardTitle>Vulnerability Categories</CardTitle>
            <CardDescription> Distribution of findings by category (Top 10). </CardDescription>
        </CardHeader>
        <CardContent class="flex-1 pb-6">
            <BarChart
                v-if="chartData.length > 0"
                :data="chartData"
                index="name"
                :categories="['total']"
                :y-formatter="(v: number) => v.toString()"
                :colors="['#ef4444']"
                :show-x-axis="false"
                :show-legend="false"
                layout="vertical"
            />
            <div v-else class="text-muted-foreground py-10 text-center">No data to display.</div>
        </CardContent>
    </Card>
</template>
